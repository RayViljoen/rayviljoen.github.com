<!DOCTYPE html>
<html lang="en">
  <head><!--[if lt IE 9]>
    <script src="dist/html5shiv.js"></script><![endif]-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="author" content="Ray Viljoen">
    <meta name="description" content="Simplify build phases and deployment by running Mocha tests programmatically.">
    <title>Running tests with Mocha's JS API</title>
    <link rel="alternate" href="http://rayviljoen.github.com/feed.xml" type="application/rss+xml">
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div id="wrapper" class="clearfix">
      <header id="dash">
        <h1>
          <!-- Wrap last letter of title in span for style purposes--><a href="/"><span>R</span>Viljoen</a>
        </h1>
        <ul id="social" class="clearfix">
          <li class="feed"><a href="/feed.xml">Feed</a></li>
          <li class="github"><a href="https://github.com/RayViljoen">GitHub</a></li>
          <li class="email"><a href="mailto:rayviljoen@me.com">Email</a></li>
        </ul>
        <ul id="menu" class="clearfix">
          <li><a href="/archive/#PHP" class="PHP catAnchor">PHP</a></li>
          <li><a href="/archive/#OSX" class="OSX catAnchor">OSX</a></li>
          <li><a href="/archive/#JavaScript" class="JavaScript catAnchor">JavaScript</a></li>
          <li><a href="/archive/#NodeJS" class="NodeJS catAnchor">NodeJS</a></li>
        </ul><a href="/archive/" id="archive">Older entries</a>
      </header>
      <div id="content" class="clearfix">
        <article class="post open">
          <header>
            <h2>Running tests with Mocha's JS API</h2>
            <div class="post-meta clearfix">
              <div class="post-date">May 25th, 2011</div>
              <div class="post-categories"><a href="/archive/#JavaScript">JavaScript ,</a><a href="/archive/#NodeJS">NodeJS</a>
              </div>
            </div>
          </header><p>The <a href="http://visionmedia.github.com/mocha/">Mocha</a> testing framework has quickly become a favourite amongst Node developers and now, with the release of v1.0, includes a very useful JavaScript API for running tests from within you code.

</p>
<p><span class="more"></span>

</p>
<p>Running tests from within <em>server.js</em>, or equivalent, removes the need for writing these commands into a separate shell script and allows you to respond to the outcome of the tests in a much more convenient way.

</p>
<p>Documentation for the new API is yet to be completed, although most options are very similar to the cli.


</p>
<p>To get started, first create a new instance of Mocha and then include the testing library of your choice.

</p>
<pre class="language-javascript"><code class="language-javascript">

    var mocha = new (require(&apos;mocha&apos;))();
    var should = require(&apos;should&apos;);

</code></pre>

<p>Next, set some basic configuration options and include the test files.
Unlike the cli, which has the <strong><em>--recursive</em></strong> flag for stepping through a directory, individual test files has to be added to the <strong><em>mocha.files</em></strong> array.

</p>
<pre class="language-javascript"><code class="language-javascript">

    var testFiles = [ &apos;./tests/test1.js&apos;, &apos;./tests/test2.js&apos; ];
    mocha.files = files;

</code></pre>

<p>Mocha also provides a helper method for adding test files individually.

</p>
<pre class="language-javascript"><code class="language-javascript">

    mocha.addFile(&apos;./tests/test1.js&apos;);
    mocha.addFile(&apos;./tests/test2.js&apos;);

</code></pre>

<p>Some of the other useful options include allowed globals &amp; of course the reporter.

</p>
<pre class="language-javascript"><code class="language-javascript">

    mocha.reporter(&apos;spec&apos;);
    mocha.options.globals = [&apos;someGlobal&apos;, &apos;anotherGlobal&apos;];

</code></pre>

<p>Finally call <strong><em>run</em></strong>, which provides a <strong><em>done</em></strong> callback, and handle the <strong><em>pass</em></strong> or <strong><em>fail</em></strong> event for each test on the object returned from the <strong><em>run</em></strong> method.

</p>
<pre class="language-javascript"><code class="language-javascript">

    var tests = mocha.run(function() {
        console.log(&apos;All tests are done&apos;);
    });

    tests.on(&apos;pass&apos;, function(test) {
        console.log(&apos;Passed:&apos; + test.title);
    });

    tests.on(&apos;fail&apos;, function(test) {
        console.log(&apos;Failed&apos; + test.title);
    });

</code></pre>

<p>Here&apos;s a complete example of implementing this in a project and automatically running the tests when in dev mode.
Using a <a href="https://npmjs.org/package/glob">glob helper</a> simplifies adding test files and allows you to easily use a multi level directory for your test files.

</p>
<pre class="language-javascript"><code class="language-javascript">

    // Check node is running in dev mode
    if(NODE_ENV === &apos;development&apos;) {

        var mocha = new (require(&apos;mocha&apos;))();
        var should = require(&apos;should&apos;);
        var tests;

        // Set reporter
        mocha.reporter(&apos;spec&apos;);

        // Glob all test files and run tests in callback
        glob(&apos;./test/*&apos;, function(e, files) {

            mocha.files = files;
            tests = mocha.run();
        });
    }

</code></pre>

<p>Happy testing!
</p>
<br>
          <div id="disqus_thread"></div>
          <script type="text/javascript">
            //- * * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'parsedd'; //- required: replace example with your forum shortname
            
            //- Only set to dev mode if on localhost
            if(location.hostname === 'localhost') {
                var disqus_developer = 1;
            }
            
            //- * * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        </article>
      </div>
      <script src="/js/main.js"></script>
      <script>
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29106812-1']);
        _gaq.push(['_trackPageview']);
        
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
    </div>
  </body>
</html>